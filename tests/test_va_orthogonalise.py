"""Test the va_orthogonalise function.

The va_orthogonalise function is used to orthogonalise a series of
functions using the Vandermonde with Arnoldi method. This test suite
checks that the function can be imported and that it works for a
small simple analytic example and a large example generated by the
MATLAB code. The MATLAB results are included in the tests/data
directory.
"""
from test_settings import ATOL, RTOL


def test_import_va_orthogonalise():
    """Test that the VA_orthogonalise function can be imported."""
    from pylars.numerics import va_orthogonalise

    assert va_orthogonalise is not None


def test_simple_va_orthogonalise():
    """Test against a simple VA_orthogonalise example."""
    from pylars.numerics import va_orthogonalise
    import numpy as np
    from numpy import sqrt

    Z = np.array([0, 2, 1 + 1j]).reshape(3, 1)
    n = 1
    H_answer = np.array([1 + 1j / 3, 2 * sqrt(2) / 3]).reshape(2, 1)
    Q_answer = np.array(
        [
            [1, 1, 1],
            [
                -3 / (2 * sqrt(2)) - 1j / (2 * sqrt(2)),
                3 / (2 * sqrt(2)) - 1j / (2 * sqrt(2)),
                1j / sqrt(2),
            ],
        ]
    ).T
    hessenbergs, Q = va_orthogonalise(Z, n)
    H = hessenbergs[0]
    assert np.allclose(H, H_answer, atol=ATOL, rtol=RTOL)
    assert np.allclose(Q, Q_answer, atol=ATOL, rtol=RTOL)
    assert np.allclose((Q @ H), Z, atol=ATOL, rtol=RTOL)


def test_large_va_orthongalise():
    """Test against a large polynomial example generated by the MATLAB code."""
    from pylars.numerics import va_orthogonalise
    import numpy as np
    from scipy.io import loadmat

    Z = np.exp(1j * np.linspace(0, 2 * np.pi, 100)).reshape(100, 1)
    H_answer = loadmat("tests/data/VAorthog_circle_H.mat")["H"]
    Q_answer = loadmat("tests/data/VAorthog_circle_Q.mat")["Q"]
    # check matlab input is correct using arnoldi recurrence relation
    for k in range(1, 10):
        left = np.diag(Z.flatten()) @ Q_answer[:, :k]
        right = Q_answer[:, : k + 1] @ H_answer[: k + 1, :k]
        assert np.allclose(left, right, atol=ATOL, rtol=RTOL)
    Z = np.exp(1j * np.linspace(0, 2 * np.pi, 100)).reshape(100, 1)
    hessenbergs, Q = va_orthogonalise(Z, 10)
    H = hessenbergs[0]
    assert np.allclose(H, H_answer, atol=ATOL, rtol=RTOL)
    assert np.allclose(Q, Q_answer, atol=ATOL, rtol=RTOL)
    for k in range(1, 10):
        left = np.diag(Z.flatten()) @ Q[:, :k]
        right = Q[:, : k + 1] @ H[: k + 1, :k]
        assert np.allclose(left, right, atol=ATOL, rtol=RTOL)
    # check Q has orthogonal columns with norm M
    # an exception for ATOL is made here as Q will only be
    # approximately orthogonal
    assert np.allclose(
        (Q.conj().T @ Q), len(Z) * np.eye(11), atol=1e-10, rtol=RTOL
    )


def test_poles_va_orthogonalise():
    """Test the va_orthogonalise with poles against the MATLAB code."""
    from pylars.numerics import va_orthogonalise
    from pylars import Problem
    import numpy as np
    from scipy.io import loadmat

    n, num_poles = 24, 24
    test_answers = loadmat(
        f"tests/data/lid_driven_cavity_n_{n}_np_{num_poles}.mat"
    )
    H_answer = test_answers["Hes"]
    hessenbergs_answer = [H_answer[:, k][0] for k in range(H_answer.shape[1])]
    Q_answer = test_answers["Q"]
    Z_answer = test_answers["Z"]
    poles_answer = test_answers["Pol"]
    poles_answer = np.array([poles_answer[0, i] for i in range(4)]).reshape(
        4, 24
    )
    corners = [1 + 1j, -1 + 1j, -1 - 1j, 1 - 1j]
    prob = Problem()
    prob.add_exterior_polygon(
        corners,
        num_edge_points=300,
        length_scale=1.5 * np.sqrt(2),
        sigma=4,
        deg_poly=24,
        num_poles=num_poles,
    )
    # check the MATALB domain points and poles are the same
    assert np.allclose(
        prob.domain.boundary_points, Z_answer, atol=ATOL, rtol=RTOL
    )
    assert np.allclose(prob.domain.poles, poles_answer, atol=ATOL, rtol=RTOL)
    hessenbergs, Q = va_orthogonalise(
        prob.domain.boundary_points.reshape(1200, 1),
        24,
        poles=prob.domain.poles,
    )
    for hessenberg, hessenberg_answer in zip(hessenbergs, hessenbergs_answer):
        assert np.allclose(hessenberg, hessenberg_answer, atol=ATOL, rtol=RTOL)
    assert np.allclose(Q, Q_answer, atol=ATOL, rtol=RTOL)


def test_laurent_va_orthogonalise():
    """Test the va_orthogonalise with laurent series against MATLAB code."""
    from pylars.numerics import va_orthogonalise
    from pylars import Problem
    import numpy as np
    from scipy.io import loadmat

    test_answers = loadmat("tests/data/single_circle_test.mat")
    deg_poly, num_poles, deg_laurent = (
        test_answers["n"][0][0],
        test_answers["np"][0][0],
        test_answers["nl"][0][0],
    )
    num_edge_points, num_ellipse_points = (
        test_answers["nb"][0][0],
        test_answers["np"][0][0],
    )
    H_answer = test_answers["Hes"]
    # discard empty pole blocks
    hessenbergs_answer = [
        H_answer[:, k][0]
        for k in range(H_answer.shape[1])
        if H_answer[:, k][0].shape != (0, 0)
    ]
    Q_answer = test_answers["Q"]
    Z_answer = test_answers["Z"]
    prob = Problem()
    corners = [-1 - 1j, 1 - 1j, 1 + 1j, -1 + 1j]
    prob.add_exterior_polygon(
        corners,
        num_edge_points=num_edge_points,
        num_poles=num_poles,
        deg_poly=deg_poly,
        spacing="linear",
    )
    prob.add_interior_curve(
        lambda t: 0.5 * np.exp(2j * np.pi * t),
        num_points=num_ellipse_points,
        deg_laurent=deg_laurent,
        centroid=0.0 + 0.0j,
    )
    assert np.allclose(
        prob.domain.boundary_points, Z_answer, atol=ATOL, rtol=RTOL
    )
    hessenbergs, Q = va_orthogonalise(
        prob.domain.boundary_points.reshape(-1, 1),
        deg_poly,
        interior_laurents=prob.domain.interior_laurents,
    )
    for hessenberg, hessenberg_answer in zip(hessenbergs, hessenbergs_answer):
        assert np.allclose(hessenberg, hessenberg_answer, atol=ATOL, rtol=RTOL)
    assert np.allclose(Q, Q_answer, atol=ATOL, rtol=RTOL)


if __name__ == "__main__":
    test_import_va_orthogonalise()
    test_simple_va_orthogonalise()
    test_large_va_orthongalise()
    test_poles_va_orthogonalise()
    test_laurent_va_orthogonalise()
